
<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8' />
		<meta http-equiv="X-UA-Compatible" content="chrome=1" />
		<meta name="description" content="Books Catalog" />
		<title>Books Catalog</title>
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
		<style>
			label.asc::after { content: "\25b4  "; }
			label.desc::after { content: "\25be  "; }
			span.title { font-style: italic; }
			div.add-new-book > input {  width: 30%; margin-right: 15px; }
		</style>
	</head>
	<body style>
		<div class="container">
			<div class="row">
				<h1>Books Catalog</h1>
				<p class="lead">Here it is! Deluxe Books Catalog!</p>
			</div>
			<div id="book-catalog">
				<div class="row btn-group" data-toggle="buttons" style="margin-bottom:10px;">
					<label class="sort active btn btn-default" data-sort="author">
						<input type="radio" name="options" id="author" />Author
					</label>
					<label class="sort btn btn-default" data-sort="title">
						<input type="radio" name="options" id="title" />Title
					</label>
				</div>
				<div class="row" style="margin-bottom:10px;">
					<input type="text" class="search form-control" placeholder="Search in all" style="width: 50%" />
				</div>
				<ul class="row list-group list"></ul>
			</div>
			<div class="row add-new-book">
				<input type="text" id="author-field" class="form-control" placeholder="Author" />
				<input type="text" id="title-field" class="form-control" placeholder="Title" />
				<button id="add-btn" class="btn btn-primary">Add</button>
				<button id="clean-btn" class="btn btn-default">Clean</button>
			</div>
		</div>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
		<script src="http://listjs.com/no-cdn/list.js"></script>
		<script type="text/javascript">

			function BooksStorage() {
				this.clear = function() {
					localStorage.clear();
				}
				this.addBook = function(newBook) {
					if (newBook.isValid()) {
						if (this.isNotDuplicate(newBook)) {
							booksList.add(newBook.getAsJson());
							var arrayOfBooks = booksStorage.getBooks();
							arrayOfBooks.push(newBook.getAsJson());
							localStorage.setItem('arrayOfBooks', JSON.stringify(arrayOfBooks));
						} else {
							console.log('Book "' + newBook.getBiblio() + '" is a duplicate.')
						}
					} else {
						console.log('Book "' + newBook.getBiblio() + '" is not valid.')
					}
				}
				this.getBooks = function() {
					var booksAlreadyInCatalog = localStorage.getItem('arrayOfBooks');
					return ( booksAlreadyInCatalog === null ? new Array() : JSON.parse(booksAlreadyInCatalog) );
				}
				this.isNotDuplicate = function(newBook) {
					/*console.log('Adding book "' + newBook.getBiblio() + '".')
					console.log('booksStorage.getBooks() (size ' + arrayOfBooks.length + '):');
					for (var i = 0; i < arrayOfBooks.length; i++) {
						console.log(arrayOfBooks[i]);
					}*/
					return true;
				}
			}

			function Book(author, title) {
				this.author = author;
				this.title = title;
				this.getBiblio = function() {
					return author + ', ' + title;
				}
				this.getAsJson = function() {
					return { "author": author, "title": title };
				}
				this.isValid = function() {
					return ( author && title );
				}
			}
			
			var booksListOptions = {
				valueNames: [ 'author', 'title' ],
				item: '<li class="list-group-item"><span class="author"></span>, <span class="title"></span></li>'
			};

			var booksList = new List('book-catalog', booksListOptions);

			var booksStorage = new BooksStorage();

			var addBtn = $('#add-btn'),
				cleanBtn = $('#clean-btn'),
				authorField = $('#author-field'),
				titleField = $('#title-field');
			    
			addBtn.click(function() {
				booksStorage.addBook(new Book(authorField.val(), titleField.val()));
				clearFields();
			});
			
			cleanBtn.click(function() {
				clearFields();
				booksStorage.clear();
				location.reload();
			});

			function clearFields() {
				authorField.val('');
				titleField.val('');
			}

			function loadBooksFromBooksStorage() {
				var existedBooks = booksStorage.getBooks();
				if (existedBooks.length > 0) {
					booksList.add(existedBooks);
				} else {
					putSomeTestBooks();
				}
 			}

 			function putSomeTestBooks() {
 				booksStorage.addBook(new Book("Stephen King", "To"));
 				booksStorage.addBook(new Book("Robert Ludlum", "Zemsta Bourne'a"));
 			}

 			loadBooksFromBooksStorage();
 			
		</script>
	</body>
</html>